image: docker:20.10.16

services:
  - docker:20.10.16-dind

variables:
  DOCKER_TLS_CERTDIR: ''
  IMAGE_NAME: marinaandersen1371/marina_project3
  IMAGE_TAG: latest

stages:
  - test
  - build
  - deploy

test:
  stage: test
  image: python:3.9-slim-bookworm
  before_script:
    - apt-get update
    - apt-get install -y make
  script:
    - make test

build:
  stage: build
  before_script:
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_TOKEN"
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
  only:
    - main

deploy:
  stage: deploy
  image:
    name: flyio/flyctl:latest
    entrypoint: ['']
  script:
    - flyctl deploy --image $IMAGE_NAME:$IMAGE_TAG --remote-only
  only:
    - main
